name: Build & Deploy to Aliyun OSS

on:
  pull_request:
    branches: [main]
    types: [closed]          # PR 合并后才触发
    paths: ["src/**"]        # 仅 src 变更才执行
  workflow_dispatch:         # 手动触发

jobs:
  build:
    # 仅当 PR 被合并 或 手动触发时运行
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: 22
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build
        run: yarn build   # 产物默认输出到 dist/

      - name: Upload files to OSS
        uses: fangbinwei/aliyun-oss-website-action@83a47e5e40b4185c8d221148bd314bb57015d7e4 # v1.4.1
        with:
          accessKeyId: ${{ secrets.OSS_KEY_ID }}
          accessKeySecret: ${{ secrets.OSS_KEY_SECRET }}
          bucket: ${{ secrets.OSS_BUCKET }}
          endpoint: ${{ secrets.OSS_ENDPOINT }}
          folder: ./dist
