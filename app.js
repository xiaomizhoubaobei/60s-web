import express from "express";import path from "path";import { fileURLToPath } from "url";import helmet from "helmet";import createError from "http-errors";   // 轻量级错误工厂const __filename = fileURLToPath(import.meta.url);const __dirname = path.dirname(__filename);const port = process.env.PORT || 5173;const app = express();/* 0. 安全标头 */app.use(helmet());/* 1. 静态资源：白名单扩展名 + 404 时继续向下走 */const staticRoot = path.join(__dirname, "dist");const ALLOW_EXT = new Set([    ".html", ".js", ".css", ".svg", ".png", ".jpg", ".jpeg",    ".ico", ".woff", ".woff2", ".ttf", ".map", ".json"]);app.use(    express.static(staticRoot, {        index: false,        setHeaders(res, filePath) {            if (!ALLOW_EXT.has(path.extname(filePath).toLowerCase())) {                res.status(404).end();          // 立即中断            }        }    }));/* 2. SPA 兜底：仅 GET/HEAD + 路径遍历防护 */app.get(/.*/, (req, res, next) => {          // ← 由 app.use 改为 app.get    if (req.path.includes("..") || req.path.startsWith("\\")) {        return next(createError(400, "Invalid path"));    }    res.sendFile(path.join(staticRoot, "index.html"), (err) => {        if (err) next(createError(404, "File not found"));    });});/* 3. 404 捕获 */app.use((req, res, next) => {    next(createError(404, "Route not found"));});/* 4. 集中错误处理中间件（必须 4 个参数） */// eslint-disable-next-line no-unused-varsapp.use((err,req, res, _next) => {    const status = err.status || 500;    const message = err.message || "Internal Server Error";    console.error(`[Error] ${req.method} ${req.url} - ${status} : ${message}`);    // 生产环境不泄漏堆栈    if (app.get("env") === "development") {        return res.status(status).json({ status, message, stack: err.stack });    }    res.status(status).json({ status, message });});/* 5. 启动服务器 + 端口冲突防护 */const server = app.listen(port, "0.0.0.0")    .on("error", (e) => {        if (e.code === "EADDRINUSE") {            console.error(`端口 ${port} 已被占用，启动失败`);            process.exit(1);        }        console.error("服务器启动异常:", e);        process.exit(1);    })    .on("listening", () => {        console.log(`应用已启动，监听 0.0.0.0:${port}`);    });/* 6. 优雅退出（可选，容器场景也适用） */process.on("SIGTERM", () => {    console.log("收到 SIGTERM，开始优雅关闭...");    server.close(() => process.exit(0));});